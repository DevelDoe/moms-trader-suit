<!DOCTYPE html>
<html lang="en-G">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Settings</title>
        <link rel="stylesheet" href="../../styles/styles.css" />
        <style>
            .settings-container {
                padding: 20px;
                max-width: 400px;
                margin: 0 auto;
                color: #fff;
            }
            .remove-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
                margin-left: 5px;
            }

            .trash-icon {
                width: 16px; /* Adjust size as needed */
                height: 16px;
            }

            .remove-btn:hover .trash-icon {
                filter: brightness(0.8); /* Darken icon on hover */
            }
        </style>
    </head>
    <body>
        <div class="settings-container">
            <h1 class="dragable">Settings</h1>
            <button id="restart-app-button">Restart App</button>

            <!-- Reminder Settings -->
            <section id="reminder-settings">
                <h2>Reminder Items</h2>
                <div>
                    <input type="text" id="new-reminder-text" placeholder="Reminder text" />
                    <select id="new-reminder-type">
                        <option value="critical">Critical</option>
                        <option value="optional">Optional</option>
                        <option value="reminder">Reminder</option>
                    </select>
                    <button id="add-reminder-btn">Add Item</button>
                </div>
                <ul id="reminder-items"></ul>
            </section>

            <!-- Checklist Settings -->
            <section id="checklist-settings">
                <h2>Checklist</h2>
                <div>
                    <input type="text" id="new-item-text" placeholder="Checklist item text" />
                    <select id="new-item-type">
                        <option value="critical">Critical</option>
                        <option value="optional">Optional</option>
                        <option value="reminder">Reminder</option>
                    </select>
                    <button id="add-item-btn">Add Item</button>
                </div>
                <ul id="checklist-items"></ul>
                <button id="reset-legacy-checklist-btn">Reset to Legacy Checklist</button>
            </section>

            <!-- Countdown Settings -->
            <section id="countdown">
                <h2>Bar Countdown</h2>
                <div>
                    <label for="volume-slider">Volume:</label>
                    <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.5" />
                </div>
            </section>

            <!-- Session Countdowns -->
            <section id="session-countdowns">
                <h2>Session Countdowns</h2>
                <div>
                    <label for="session-volume-slider">ðŸ”Š Session Bell Volume:</label>
                    <input id="session-volume-slider" type="range" min="0" max="1" step="0.01" value="0" />
                </div>
                <div>
                    <label for="session-time">Session Time:</label>
                    <input type="time" id="session-time" />
                </div>
                <div>
                    <label for="session-title">Countdown Title:</label>
                    <input type="text" id="session-title" placeholder="Countdown Title" />
                </div>
                <div>
                    <label for="session-countdown">Countdown Duration:</label>
                    <select id="countdown-hours"></select>
                    <select id="countdown-minutes"></select>
                </div>
                <button id="add-session-btn">Add Session Countdown</button>
                <ul id="session-list"></ul>
            </section>

            <!-- Screen Management -->
            <section id="screen-management">
                <h2>Screen Management</h2>
                <div id="screenControls"></div>
            </section>

            <br />
            <button onclick="window.electronAPI.toggleSettings()">Close</button>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                try {
                    const settings = await window.electronAPI.getSettings();
                    initializeReminderSection(settings.reminderItems || []);
                    initializeChecklistSection(settings.checklist || []);
                    initializeCountdownSection(settings);
                    initializeSessionCountdowns(settings.sessionCountdowns || [], settings.sessionVolume);
                    initializeCountdownDuration();

                    // Event listeners
                    document.getElementById("restart-app-button").addEventListener("click", restartApp);
                    document.getElementById("add-reminder-btn").addEventListener("click", addReminderItem);
                    document.getElementById("add-item-btn").addEventListener("click", addChecklistItem);
                    document.getElementById("reset-legacy-checklist-btn").addEventListener("click", resetChecklist);

                    // Listen for global settings updates
                    window.electronAPI.onSettingsUpdated((updatedSettings) => {
                        console.log("Settings updated globally:", updatedSettings);
                        initializeReminderSection(updatedSettings.reminderItems || []);
                        initializeChecklistSection(updatedSettings.checklist || []);
                        initializeSessionCountdowns(updatedSettings.sessionCountdowns || [], updatedSettings.sessionVolume);
                    });
                } catch (error) {
                    console.error("Initialization error:", error);
                }
            });

            // Reminder Section
            function initializeReminderSection(items) {
                const reminderList = document.getElementById("reminder-items");
                reminderList.innerHTML = "";

                items.forEach((item, index) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${item.text} (${item.type})`;

                    // Create the remove button
                    const removeButton = document.createElement("button");
                    removeButton.className = "remove-btn";
                    removeButton.setAttribute("aria-label", "Remove item");

                    // Create the trash icon image
                    const trashIcon = document.createElement("img");
                    trashIcon.src = "../../../assets/images/delete.svg"; // Ensure this path is correct
                    trashIcon.alt = "Remove";
                    trashIcon.className = "trash-icon";

                    removeButton.appendChild(trashIcon);

                    removeButton.addEventListener("click", () => {
                        items.splice(index, 1);
                        saveSettings({ reminderItems: items });
                    });

                    listItem.appendChild(removeButton);
                    reminderList.appendChild(listItem);
                });
            }

            function addReminderItem() {
                const text = document.getElementById("new-reminder-text").value.trim();
                const type = document.getElementById("new-reminder-type").value;

                if (!text) {
                    alert("Enter reminder text.");
                    return;
                }

                window.electronAPI.getSettings().then((settings) => {
                    const updatedItems = [...(settings.reminderItems || []), { text, type }];
                    saveSettings({ reminderItems: updatedItems });
                });
            }

            // Checklist Section
            function initializeChecklistSection(items) {
                const checklistContainer = document.getElementById("checklist-items");
                checklistContainer.innerHTML = "";

                items.forEach((item, index) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${item.text} (${item.type})`;

                    // Create the remove button
                    const removeButton = document.createElement("button");
                    removeButton.className = "remove-btn";
                    removeButton.setAttribute("aria-label", "Remove item");

                    // Create the trash icon image
                    const trashIcon = document.createElement("img");
                    trashIcon.src = "../../../assets/images/delete.svg"; // Ensure this path is correct
                    trashIcon.alt = "Remove";
                    trashIcon.className = "trash-icon";

                    removeButton.appendChild(trashIcon);

                    removeButton.addEventListener("click", async () => {
                        await window.electronAPI.removeChecklistItem(index);
                        window.electronAPI.getSettings().then((settings) => {
                            initializeChecklistSection(settings.checklist || []);
                        });
                    });

                    listItem.appendChild(removeButton);
                    checklistContainer.appendChild(listItem);
                });
            }

            function addChecklistItem() {
                const text = document.getElementById("new-item-text").value.trim();
                const type = document.getElementById("new-item-type").value;
                if (!text) return alert("Enter checklist item text.");

                window.electronAPI.addChecklistItem({ text, type });
                window.electronAPI.getSettings().then((settings) => {
                    initializeChecklistSection(settings.checklist || []);
                });
            }

            function resetChecklist() {
                window.electronAPI.resetToLegacyChecklist();
                window.electronAPI.getSettings().then((settings) => {
                    initializeChecklistSection(settings.checklist || []);
                });
            }

            // Countdown Bar Section
            function initializeCountdownSection(settings) {
                const slider = document.getElementById("volume-slider");
                slider.value = settings.volume || 0.5;
                slider.addEventListener("input", () => window.electronAPI.setVolume(slider.value));
            }

            // Session Countdowns
            function initializeSessionCountdowns(sessions, sessionVolume) {
                document.getElementById("add-session-btn").addEventListener("click", async () => {
                    const sessionTimeInput = document.getElementById("session-time").value;
                    const sessionTitleInput = document.getElementById("session-title").value.trim();
                    const hours = parseInt(document.getElementById("countdown-hours").value, 10);
                    const minutes = parseInt(document.getElementById("countdown-minutes").value, 10);

                    if (!sessionTimeInput || !sessionTitleInput || isNaN(hours) || isNaN(minutes)) {
                        alert("Please fill in all session details.");
                        return;
                    }

                    // Parse the session start time
                    const [startHour, startMinute] = sessionTimeInput.split(":").map(Number);
                    const startTime = new Date();
                    startTime.setHours(startHour, startMinute, 0, 0);

                    // Calculate the end time by adding the duration
                    const endTime = new Date(startTime.getTime() + hours * 60 * 60 * 1000 + minutes * 60 * 1000);

                    // Format start and end times as HH:MM
                    const formatTime = (date) => date.toTimeString().slice(0, 5);
                    const session = {
                        start: formatTime(startTime),
                        end: formatTime(endTime),
                        title: sessionTitleInput,
                    };

                    // Retrieve existing sessions, add the new session, and save
                    const settings = await window.electronAPI.getSettings();
                    const updatedSessions = [...(settings.sessionCountdowns || []), session];
                    saveSettings({ sessionCountdowns: updatedSessions });

                    // Clear input fields
                    document.getElementById("session-time").value = "";
                    document.getElementById("session-title").value = "";
                    document.getElementById("countdown-hours").value = "";
                    document.getElementById("countdown-minutes").value = "";
                });

                // Volumw

                const sessionList = document.getElementById("session-list");
                const sessionVolumeSlider = document.getElementById("session-volume-slider");

                sessionList.innerHTML = "";

                // Populate session list
                sessions.forEach((session, index) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${session.start} - ${session.end} | ${session.title}`;

                    const removeButton = document.createElement("button");
                    removeButton.textContent = "Remove";
                    removeButton.addEventListener("click", () => {
                        sessions.splice(index, 1);
                        saveSettings({ sessionCountdowns: sessions });
                    });

                    listItem.appendChild(removeButton);
                    sessionList.appendChild(listItem);
                });

                // **Prevent Infinite Loop & Add Deadzone**
                let isUserAdjusting = false;
                let volumeUpdateTimeout = null;

                // **Set initial slider value ONCE when opening settings**
                sessionVolumeSlider.value = sessionVolume || 0.1; // Default to 0.1 if no saved value

                sessionVolumeSlider.addEventListener("input", () => {
                    if (!isUserAdjusting) {
                        isUserAdjusting = true; // Prevent recursion
                    }

                    // **Clear previous timeout to reset the delay**
                    clearTimeout(volumeUpdateTimeout);

                    // **Set a new timeout for 1 second (1000ms)**
                    volumeUpdateTimeout = setTimeout(() => {
                        const newVolume = sessionVolumeSlider.value;
                        console.log(`ðŸ”Š User finalized session volume: ${newVolume}`);
                        window.electronAPI.setSessionVolume(newVolume);
                        saveSettings({ sessionVolume: newVolume });

                        isUserAdjusting = false; // Allow updates again
                    }, 500); // 1-second delay after user stops dragging
                });

                // **Ensure slider does NOT auto-update while the user is adjusting**
                window.electronAPI.onSessionVolumeUpdate((volume) => {
                    if (!isUserAdjusting) {
                        console.log(`ðŸ”Š Updating UI session volume to: ${volume}`);
                        sessionVolumeSlider.value = volume;
                    }
                });
            }

            function initializeSessionCountdowns(sessions, sessionVolume) {
                const sessionList = document.getElementById("session-list");
                const sessionVolumeSlider = document.getElementById("session-volume-slider");

                sessionList.innerHTML = "";

                // Populate session list
                sessions.forEach((session, index) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${session.start} - ${session.end} | ${session.title}`;

                    const removeButton = document.createElement("button");
                    removeButton.textContent = "Remove";
                    removeButton.addEventListener("click", () => {
                        sessions.splice(index, 1);
                        saveSettings({ sessionCountdowns: sessions });
                        initializeSessionCountdowns(sessions, sessionVolume); // Refresh the list
                    });

                    listItem.appendChild(removeButton);
                    sessionList.appendChild(listItem);
                });

                // Set initial slider value
                sessionVolumeSlider.value = sessionVolume || 0.1;

                sessionVolumeSlider.addEventListener("input", () => {
                    const newVolume = sessionVolumeSlider.value;
                    window.electronAPI.setSessionVolume(newVolume);
                    saveSettings({ sessionVolume: newVolume });
                });
            }

            function saveSettings(newSettings) {
                console.log("Saving settings:", newSettings);
                window.electronAPI.updateSettings(newSettings);
            }

            function restartApp() {
                window.electronAPI.restartApp();
            }

            function saveSettings(newSettings) {
                console.log("Saving settings:", newSettings);
                window.electronAPI.updateSettings(newSettings);
            }

            function restartApp() {
                window.electronAPI.restartApp();
            }
        </script>
    </body>
</html>
